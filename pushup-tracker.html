<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Push-up Tracker</title>
  <style>
    :root { --bg:#0b0b0c; --fg:#e7e7ea; --muted:#9aa0a6; --card:#151517; --accent:#4f8cff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    html,body{height:100%}
    body{margin:0;font:18px system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);display:flex;flex-direction:column}
    header{padding:24px 32px;border-bottom:1px solid #222;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    header h1{font-size:28px;margin:0;letter-spacing:.3px}
    
    /* NEW LAYOUT STYLES */
    main{
      width: 100%;
      max-width: 1600px; /* Increased max width for dashboard look */
      margin: 0 auto;
      padding: 32px;
      display: grid;
      gap: 24px;
      /* Default to single column for mobile */
      grid-template-columns: 1fr; 
    }
    
    /* Two-column layout for screens wider than 1024px (Laptops/Desktops) */
    @media (min-width: 1024px) {
        main {
            grid-template-columns: 350px 1fr; /* Fixed narrow left column, fluid wide right column */
            grid-template-areas: 
                "addset chart"
                "prs chart"
                "summary log"
                "data log";
            padding: 32px;
        }
        #addEntrySection { grid-area: addset; }
        #prSection { grid-area: prs; } /* New PR section */
        #summarySection { grid-area: summary; }
        #chartSection { grid-area: chart; }
        #logSection { grid-area: log; }
        #dataSection { grid-area: data; }
    }
    /* Two-column layout for tablets (768px to 1024px) */
    @media (min-width: 768px) and (max-width: 1023px) {
        main {
            grid-template-columns: 1fr 1fr; 
        }
    }
    /* END NEW LAYOUT STYLES */

    .card{background:var(--card);border:1px solid #222;border-radius:16px;padding:24px}
    .card h2{font-size:22px;margin:0 0 16px}
    
    /* ADJUSTED FONT SIZE FOR METRIC LABELS */
    label{
      display:block;
      font-size:14px; /* Reduced from 15px */
      color:var(--muted);
      margin-bottom:8px;
      font-weight:500;
      white-space: nowrap; /* Prevent wrapping if possible, though reducing size is primary fix */
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    input,select,button,textarea{background:#0f1012;color:var(--fg);border:1px solid #2a2b2f;border-radius:12px;padding:14px 16px;font:inherit;font-size:16px}
    input[type=date]{padding:.7rem}
    button{cursor:pointer;font-weight:500}
    button.primary{background:var(--accent);border-color:var(--accent);color:white}
    button.ghost{background:transparent}
    button.danger{background:var(--bad);border-color:var(--bad);color:white}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .row>*{flex:1 1 180px}
    .right{text-align:right}
    .pill{font-size:15px;padding:8px 14px;border-radius:999px;border:1px solid #2b2c30;color:var(--muted);font-weight:500}
    
    /* Updated grid for key stats to 3 columns on desktop, 2 on tablet, 1 on mobile */
    .key-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
    @media (max-width:1023px) and (min-width: 768px){.key-stats-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:767px){.key-stats-grid{grid-template-columns:1fr}}
    
    /* New PR grid: 3 columns fluid on large screens, stacks on mobile */
    .pr-grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));gap:20px}
    
    .status{font-weight:600;font-size:32px}
    /* Reduced font size for smaller status metrics that are likely to wrap */
    #avgSet, #setsToday { font-size: 24px !important; }

    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    details summary{cursor:pointer;color:var(--muted);user-select:none;font-size:16px}
    details summary:hover{color:var(--fg)}
    .spacer{height:2px;background:#1b1b1e;margin:12px 0}
    .month-group{margin-bottom:20px;border:1px solid #333;border-radius:12px;overflow:hidden}
    .month-header{padding:18px 24px;background:#1f1f21;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;font-size:19px}
    .month-header:hover{background:#242426}
    .month-content{padding:16px;background:var(--bg)}
    .day-group{margin-bottom:16px;border:1px solid #222;border-radius:10px;overflow:hidden}
    .day-header{padding:14px 20px;background:#1a1a1c;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;font-size:16px}
    .day-header:hover{background:#1f1f21}
    .day-sets{padding:12px;background:var(--card)}
    .set-item{padding:14px 16px;margin:8px 0;background:#0f1012;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:16px;font-size:16px}
    .set-info{flex:1}
    .set-actions{display:flex;gap:10px}
    .set-actions button{padding:10px 16px;font-size:15px}

    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal{background:var(--card);border:1px solid #333;border-radius:16px;padding:32px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
    .modal h3{margin:0 0 24px;font-size:24px}
    .modal-buttons{display:flex;gap:12px;margin-top:24px;justify-content:flex-end}
    .modal-buttons button{min-width:100px}
    .modal input,.modal textarea{width:100%;box-sizing:border-box;margin-bottom:16px}
    .modal textarea{min-height:80px;resize:vertical;font-family:inherit}
    .modal label{display:block;margin-bottom:4px}
    
    /* Streak badge */
    .streak-badge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#f59e0b,#ef4444);padding:10px 16px;border-radius:12px;font-weight:600;color:white;font-size:16px}
    .streak-emoji{font-size:20px}
    
    /* Achievement celebration */
    .celebration{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border:2px solid var(--ok);border-radius:20px;padding:40px;text-align:center;z-index:2000;animation:popIn 0.3s ease-out}
    .celebration h2{margin:0 0 16px;font-size:32px;color:var(--ok)}
    .celebration p{font-size:18px;margin:0 0 24px;color:var(--muted)}
    .celebration button{min-width:120px}
    @keyframes popIn{from{transform:translate(-50%,-50%) scale(0.8);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
    
    /* Warning banner */
    .warning-banner{background:#ef444420;border:1px solid var(--bad);border-radius:12px;padding:16px;margin-bottom:16px;display:flex;align-items:start;gap:12px}
    .warning-banner strong{color:var(--bad)}
    
    /* Trend indicators */
    .trend{display:inline-flex;align-items:center;gap:6px;font-size:18px;margin-left:12px}
    .trend.up{color:var(--ok)}
    .trend.down{color:var(--bad)}
    .trend.stable{color:color:var(--muted)}
    
    /* Comparison card */
    .comparison{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center;padding:16px;background:#1a1a1c;border-radius:10px;margin:12px 0}
    .comparison-stat{text-align:center}
    .comparison-label{font-size:14px;color:var(--muted);margin-bottom:4px}
    .comparison-value{font-size:24px;font-weight:600}
    .comparison-arrow{font-size:32px;color:var(--muted)}
    @media (max-width:720px){.comparison{grid-template-columns:1fr;gap:8px}.comparison-arrow{display:none}}
    
    /* Keyboard focus styles */
    button:focus-visible, input:focus-visible, select:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .month-header:focus, .day-header:focus{outline:2px solid var(--accent);outline-offset:-2px}
    
    /* Loading state */
    .updating{opacity:0.6;pointer-events:none;transition:opacity 0.2s}
  </style>
</head>
<body>
  <header>
    <h1>Push-up Tracker</h1>
    <!-- Updated to Local Storage -->
    <span class="pill" id="storageInfo">Local Storage</span>
    <div class="pill" id="weekInfo">Week: ‚Äî</div>
    <div id="streakBadge"></div>
  </header>
  <main id="appContent" class="updating">
    <div id="loadingIndicator" style="text-align:center;padding:50px;font-size:20px;color:var(--muted)">
      Loading your data...
    </div>
    
    <!-- LEFT COLUMN SECTIONS -->

    <section class="card" aria-labelledby="addEntryH" style="display:none" data-section id="addEntrySection">
      <h2 id="addEntryH">Add Set</h2>
      <div class="row">
        <div>
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="reps">Reps</label>
          <input id="reps" type="number" min="1" inputmode="numeric" placeholder="e.g. 20" />
        </div>
        <div>
          <label for="note">Notes</label>
          <input id="note" type="text" placeholder="e.g. standard, tricep" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="addBtn">Add Set</button>
        <button id="clearTodayBtn" class="ghost">Clear Today</button>
        <span class="pill" id="todayTotal">Today: 0</span>
      </div>
    </section>
    
    <!-- NEW SECTION: PERSONAL RECORDS (PRs) -->
    <section class="card" aria-labelledby="prH" style="display:none" data-section id="prSection">
        <h2 id="prH">Personal Records (PRs)</h2>
        <!-- UPDATED: Changed to a 3-column grid -->
        <div class="pr-grid" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
            <div>
              <label>Highest Single Set üí™</label>
              <div class="status ok" id="highestSet">0</div>
            </div>
            <!-- NEW: Highest Daily Total -->
            <div>
              <label>Highest Daily Total üöÄ</label>
              <div class="status ok" id="highestDailyTotal">0</div>
            </div>
            <div>
              <label>Highest Weekly Total üèÜ</label>
              <div class="status ok" id="highestWeeklyTotal">0</div>
            </div>
        </div>
    </section>

    <section class="card" aria-labelledby="summaryH" style="display:none" data-section id="summarySection">
      <h2 id="summaryH">Summary & Goals</h2>
      <div class="key-stats-grid">
        <div>
          <label>Daily Total</label>
          <div class="status" id="dailyTotal">0</div>
        </div>
        <div>
          <label>Weekly Total</label>
          <div class="status" id="weeklyTotal">0</div>
        </div>
        <div>
          <label>All-time Total</label>
          <div class="status" id="allTimeTotal">0</div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="key-stats-grid">
        <!-- Metrics with slightly smaller status text to reduce wrapping -->
        <div>
          <label>Average Per Set</label>
          <div class="status" id="avgSet" style="font-size:28px">0</div>
        </div>
        <div>
          <label>Sets Today</label>
          <div class="status" id="setsToday" style="font-size:28px">0</div>
        </div>
        <!-- Added empty filler for better layout on smaller screens if necessary -->
        <div class="hidden lg:block"></div> 
      </div>
      <div class="spacer"></div>
      <div class="row">
        <div style="flex: 2 2 180px;">
          <label for="dailyTarget">Daily Target</label>
          <input id="dailyTarget" type="number" min="0" value="30" />
        </div>
        <div style="align-self:end; flex: 1 1 100px;">
          <span class="pill" id="targetStatus">0% of target</span>
        </div>
      </div>
      
      <div class="spacer"></div>
      <h3 style="font-size:18px;margin:0 0 12px;color:var(--muted)">Weekly Progress</h3>
      <div class="comparison">
        <div class="comparison-stat">
          <div class="comparison-label">Last Week</div>
          <div class="comparison-value" id="lastWeekTotal">0</div>
        </div>
        <div class="comparison-arrow" id="trendArrow">‚Üí</div>
        <div class="comparison-stat">
          <div class="comparison-label">This Week</div>
          <div class="comparison-value" id="thisWeekTotal">0</div>
        </div>
      </div>
      <div id="weeklyComparison" style="text-align:center;font-size:16px;color:var(--muted)"></div>
    </section>

    <!-- RIGHT COLUMN SECTIONS -->

    <section class="card" aria-labelledby="chartH" style="display:none" data-section id="chartSection">
      <h2 id="chartH">Progress Chart</h2>
      <div style="position:relative;height:400px">
        <canvas id="chart"></canvas>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="chartDays">Show last</label>
          <select id="chartDays">
            <option value="7">7 days</option>
            <option value="14">14 days</option>
            <option value="30" selected>30 days</option>
            <option value="90">90 days</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="logH" style="display:none" data-section id="logSection">
      <h2 id="logH">Log History</h2>
      <div class="row" style="margin-bottom:16px">
        <button id="expandAllBtn" class="ghost">Expand all</button>
        <button id="collapseAllBtn" class="ghost">Collapse all</button>
      </div>
      <div id="logContainer"></div>
      <div style="margin-top:16px;padding:16px;background:#1a1a1c;border-radius:10px;font-size:17px">
        <strong>Total sets:</strong> <span id="totalSets">0</span> | 
        <strong>Total reps:</strong> <span id="totalReps">0</span>
      </div>
      <!-- Updated storage description -->
      <p style="color:var(--muted);margin:12px 0 0;font-size:14px">Data is stored in local storage, only available on this device.</p>
    </section>

    <section class="card" aria-labelledby="dataH" style="display:none" data-section id="dataSection">
      <h2 id="dataH">Data Management & Backup</h2>
      <!-- UPDATED: Added Manual Email Backup button -->
      <div class="row" style="margin-bottom:12px">
        <button id="exportBtn">Export JSON</button>
        <input type="file" id="importFile" accept="application/json" />
        <button id="importBtn">Import</button>
      </div>
      <div class="row">
        <button id="backupBtn" class="primary">Manual Email Backup</button>
        <button id="resetBtn" class="danger">Reset all</button>
      </div>
      
      <details style="margin-top:16px">
        <summary>See raw JSON</summary>
        <pre id="raw" style="white-space:pre-wrap;font-size:14px"></pre>
      </details>
      <!-- Updated storage description -->
      <p style="color:var(--muted);margin:12px 0 0;font-size:14px">Your data is stored locally in your browser and is not synced. The daily email backup runs automatically if this window is open at 12:15 AM.</p>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <!-- ADDED: EmailJS SDK for email backups -->
  <script src="https://cdn.emailjs.com/sdk/v3/email.min.js"></script>
  <script type="module">
    // --- Storage Setup using Local Storage Only ---
    const STORAGE_KEY = 'pushup_tracker_data';
    
    // --- EMAILJS CONFIGURATION (REPLACED WITH USER'S CREDENTIALS) ---
    // Template: template_p5mez4i
    // Service: service_uytnfr4
    // Public Key: 55PGXk4S6xIqSJ2Lq
    const EMAILJS_SERVICE_ID = 'service_uytnfr4'; 
    const EMAILJS_TEMPLATE_ID = 'template_p5mez4i'; 
    const EMAILJS_PUBLIC_KEY = '55PGXk4S6xIqSJ2Lq'; 
    const LAST_BACKUP_KEY = 'pushup_tracker_last_backup_date';
    
    // Initialize EmailJS
    if (typeof emailjs !== 'undefined' && EMAILJS_PUBLIC_KEY.startsWith('55PGXk4S6xIqSJ2Lq') === true) {
        emailjs.init(EMAILJS_PUBLIC_KEY);
    }

    // UPDATED STATE: Added highestDailyTotal alongside highestWeeklyTotal
    let state = { entries: [], target: 30, lastStreak: 0, highestWeeklyTotal: 0, highestDailyTotal: 0 };
    let isStorageReady = false; 
    let chartInstance = null;
    let renderDebounceTimer = null;
    let lastRenderedState = null;
    
    const $ = sel => document.querySelector(sel);
    const todayISO = () => {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    
    // ADDED: Simple custom alert replacement for feedback
    function alertMessage(title, message, type) {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `
          <div class="modal" style="text-align:center">
            <h3 style="color:var(--${type})">${title}</h3>
            <p style="color:var(--muted);margin:16px 0">${message}</p>
            <button class="primary" onclick="this.closest('.modal-overlay').remove()">OK</button>
          </div>
        `;
        document.body.appendChild(overlay);
        // Remove on click outside or after 4s
        setTimeout(() => overlay.remove(), 4000);
        overlay.addEventListener('click', (e) => {
            if(e.target === overlay) overlay.remove();
        });
    }

    // Helper to show/hide the main content after loading
    function toggleContent(show) {
        const appContent = $('#appContent');
        const loadingIndicator = $('#loadingIndicator');
        appContent.classList.toggle('updating', !show);
        loadingIndicator.style.display = show ? 'none' : 'block';
        
        document.querySelectorAll('[data-section]').forEach(el => {
            el.style.display = show ? 'grid' : 'none';
        });
        
        // Update storage info pill to reflect local storage
        $('#storageInfo').textContent = 'Local Storage';
    }

    // --- Storage Functions using Local Storage ---

    /**
     * Loads state from localStorage.
     * Synchronous implementation.
     */
    function loadState() {
      try {
        const localData = localStorage.getItem(STORAGE_KEY);
        if (localData) {
          const loadedState = JSON.parse(localData);
          // Ensure new fields exist on old state objects
          state = {
            entries: loadedState.entries || [],
            target: loadedState.target || 30,
            lastStreak: loadedState.lastStreak || 0,
            highestWeeklyTotal: loadedState.highestWeeklyTotal || 0,
            highestDailyTotal: loadedState.highestDailyTotal || 0, // Initialize new field
          };
          console.log('Loaded state from localStorage.');
        } else {
          // No data found, use defaults
          state = { entries: [], target: 30, lastStreak: 0, highestWeeklyTotal: 0, highestDailyTotal: 0 };
          console.log('Using default state.');
        }
      } catch (error) {
        console.error('Error loading state from localStorage:', error);
        state = { entries: [], target: 30, lastStreak: 0, highestWeeklyTotal: 0, highestDailyTotal: 0 };
      }
    }

    /**
     * Saves state to localStorage.
     * Synchronous implementation.
     */
    function saveState(newState) {
      state = newState;
      
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newState));
        console.log('State saved to localStorage.');
      } catch (error) {
        console.error('Error saving to localStorage:', error);
      }
      
      render();
    }
    
    // --- EMAILJS BACKUP LOGIC ---

    /**
     * Sends the current state as a backup email via EmailJS.
     * Updates LAST_BACKUP_KEY in localStorage upon success.
     */
    function sendBackupEmail() {
      if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY.startsWith('55PGXk4S6xIqSJ2Lq') === false || typeof emailjs === 'undefined' || !emailjs.init) {
          console.warn("EmailJS is not fully configured or SDK not loaded. Backup skipped.");
          return Promise.resolve({ status: 400, text: 'Skipped - Not Configured' });
      }
      
      // Calculate stats needed for the email body
      const totalReps = state.entries.reduce((a,b)=>a+b.reps,0);
      const totalSets = state.entries.length;
      const exportDate = new Date().toLocaleString();
      
      const fullStateForBackup = { 
        ...state, 
        totalSets, 
        totalReps, 
        exportDate: new Date().toISOString() 
      };

      const templateParams = {
          subject: `Push-up Tracker Backup - ${new Date().toLocaleDateString()}`,
          totalReps: totalReps,
          totalSets: totalSets,
          backupTime: exportDate,
          // Stringify the current state to send as the full data object
          backupData: JSON.stringify(fullStateForBackup, null, 2),
      };

      console.log("Attempting to send backup email...");

      return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
          .then((response) => {
              console.log('Email successfully sent!', response.status, response.text);
              localStorage.setItem(LAST_BACKUP_KEY, todayISO()); // Record successful backup
              return response;
          })
          .catch((error) => {
              console.error('Email sending failed:', error);
              return error;
          });
    }

    /**
     * Schedules a check to run daily at 12:15 AM (00:15).
     * Only attempts to send if a backup hasn't been sent for today.
     */
    function scheduleDailyBackupCheck() {
        // Target backup time: 12:15 AM
        const targetHour = 0;
        const targetMinute = 15;
        
        const now = new Date();
        const today = todayISO();
        const lastBackupDate = localStorage.getItem(LAST_BACKUP_KEY);
        
        const isPastTargetTime = (now.getHours() > targetHour || (now.getHours() === targetHour && now.getMinutes() >= targetMinute));
        
        if (lastBackupDate !== today && isPastTargetTime) {
            console.log("Midnight backup window hit. Sending backup...");
            // Non-blocking call to send the email
            sendBackupEmail();
            // Schedule the next check in 60 minutes to ensure coverage if the first attempt fails
            setTimeout(scheduleDailyBackupCheck, 3600000); 
            return;
        }

        // Calculate delay until the next day's check window starts (00:15)
        let nextCheck = new Date(now);
        
        if (isPastTargetTime) {
            // If past the target time (e.g., it's 3 AM), schedule for 00:15 tomorrow
            nextCheck.setDate(nextCheck.getDate() + 1);
        }
        // Set time to target hour and minute
        nextCheck.setHours(targetHour, targetMinute, 0, 0);

        const delayMs = nextCheck.getTime() - now.getTime();
        
        console.log(`Scheduling next daily backup check in ${Math.round(delayMs / 3600000)} hours.`);
        setTimeout(scheduleDailyBackupCheck, delayMs);
    }
    
    // --- Init & Setup ---

    function initApp() {
      try {
        loadState();
        
        // FIXES: Calculate highest PRs based on all historical data right after loading
        calculateHighestWeeklyTotal(state.entries); 
        calculateHighestDailyTotal(state.entries);

        isStorageReady = true;
        $('#storageInfo').textContent = 'Local Storage (This Device)';
        render();
        toggleContent(true);
        
        // ADDED: Start the daily backup scheduler
        scheduleDailyBackupCheck();
        
      } catch (error) {
        console.error('App initialization failed (Local Storage):', error);
        // Still display content even if initial load fails
        isStorageReady = true; 
        $('#storageInfo').textContent = 'Local Storage Error';
        render();
        toggleContent(true);
      }
    }
    
    // Debounced render for performance
    function scheduleRender(){
      if(renderDebounceTimer){
        clearTimeout(renderDebounceTimer);
      }
      renderDebounceTimer = setTimeout(() => {
        render();
        renderDebounceTimer = null;
      }, 50);
    }

    // --- Core Application Logic ---

    function wkRange(d){
      const dt = new Date(d);
      const day = (dt.getDay()+6)%7;
      const mon = new Date(dt); mon.setDate(dt.getDate()-day);
      const sun = new Date(mon); sun.setDate(mon.getDate()+6);
      return [mon.toISOString().slice(0,10), sun.toISOString().slice(0,10)];
    }

    function totalsFor(dateStr){
      const dayTotal = state.entries.filter(e=>e.date===dateStr).reduce((a,b)=>a+b.reps,0);
      const [ws,we] = wkRange(dateStr);
      const weekTotal = state.entries.filter(e=>e.date>=ws && e.date<=we).reduce((a,b)=>a+b.reps,0);
      const all = state.entries.reduce((a,b)=>a+b.reps,0);
      return { dayTotal, weekTotal, all };
    }
    
    // NEW FUNCTION: Calculates the all-time highest daily total from scratch
    function calculateHighestDailyTotal(entries) {
        if (entries.length === 0) {
            state.highestDailyTotal = 0;
            return;
        }

        // 1. Group entries by date
        const dailyTotals = {};
        for (const entry of entries) {
            dailyTotals[entry.date] = (dailyTotals[entry.date] || 0) + entry.reps;
        }

        // 2. Find the maximum total across all recorded days
        const maxDailyTotal = Math.max(...Object.values(dailyTotals));
        
        // 3. Update the state if a new all-time high is found
        if (maxDailyTotal > state.highestDailyTotal) {
             state.highestDailyTotal = maxDailyTotal;
        }
        
        // Edge case: If current highest is 0 and we have data, use the max.
        if (state.highestDailyTotal === 0 && maxDailyTotal > 0) {
            state.highestDailyTotal = maxDailyTotal;
        }
        
        console.log('Recalculated highest daily total:', state.highestDailyTotal);
    }
    
    // NEW FUNCTION: Calculates the all-time highest weekly total from scratch
    function calculateHighestWeeklyTotal(entries) {
        if (entries.length === 0) {
            state.highestWeeklyTotal = 0;
            return;
        }

        // 1. Group entries by week start date (ISO string)
        const weeklyTotals = {};
        for (const entry of entries) {
            const [weekStart] = wkRange(entry.date);
            weeklyTotals[weekStart] = (weeklyTotals[weekStart] || 0) + entry.reps;
        }

        // 2. Find the maximum total across all recorded weeks
        const maxWeeklyTotal = Math.max(...Object.values(weeklyTotals));
        
        // 3. Update the state if a new all-time high is found
        if (maxWeeklyTotal > state.highestWeeklyTotal) {
             state.highestWeeklyTotal = maxWeeklyTotal;
        }
        
        // Edge case: If current highest is 0 and we have data, use the max.
        if (state.highestWeeklyTotal === 0 && maxWeeklyTotal > 0) {
            state.highestWeeklyTotal = maxWeeklyTotal;
        }
        
        console.log('Recalculated highest weekly total:', state.highestWeeklyTotal);
    }

    // Calculate current streak
    function calculateStreak(){
      if(state.entries.length === 0) return 0;
      
      const uniqueDates = [...new Set(state.entries.map(e => e.date))].sort((a,b) => b.localeCompare(a));
      const today = todayISO();
      
      let streak = 0;
      let checkDate = today;
      
      for(let i = 0; i < uniqueDates.length; i++){
        if(uniqueDates[i] === checkDate){
          streak++;
          // Move to previous day
          const d = new Date(checkDate);
          d.setDate(d.getDate() - 1);
          checkDate = d.toISOString().slice(0,10);
        } else {
          // Check if we should include yesterday for today's streak
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayISO = yesterday.toISOString().slice(0,10);
          
          if(i === 0 && uniqueDates[0] === yesterdayISO){
            streak++;
            const d = new Date(yesterdayISO);
            d.setDate(d.getDate() - 1);
            checkDate = d.toISOString().slice(0,10);
          } else {
            break;
          }
        }
      }
      
      return streak;
    }
    
    // Show achievement celebration
    function showAchievement(type, value){
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.background = 'rgba(0,0,0,0.9)';
      
      let title = '', message = '', emoji = '';
      
      if(type === 'streak'){
        emoji = 'üî•';
        title = `${value} Day Streak!`;
        message = `Amazing! You've worked out ${value} days in a row. Keep it up!`;
      } else if(type === 'target'){
        emoji = 'üéØ';
        title = 'Target Crushed!';
        message = `You've hit your daily target! Great work!`;
      } else if(type === 'milestone'){
        emoji = 'üèÜ';
        title = `${value} Total Reps!`;
        message = `Incredible milestone! You've completed ${value} push-ups!`;
      } else if(type === 'pr'){
        emoji = 'üí™';
        title = 'New Personal Record!';
        message = `${value} reps in a single set! That's your best yet!`;
      } else if(type === 'daily_pr'){
        emoji = 'üöÄ';
        title = 'New Daily Record!';
        message = `${value} reps in a single day! That's your highest daily total yet!`;
      } else if(type === 'weekly_pr'){
        emoji = 'ü•á';
        title = 'New Weekly Record!';
        message = `${value} reps this week! Your highest weekly total yet!`;
      }
      
      overlay.innerHTML = `
        <div class="celebration">
          <div style="font-size:64px;margin-bottom:16px">${emoji}</div>
          <h2>${title}</h2>
          <p>${message}</p>
          <button class="primary" onclick="this.closest('.modal-overlay').remove()">Awesome!</button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      overlay.addEventListener('click', (e) => {
        if(e.target === overlay) overlay.remove();
      });
      
      // Auto-remove after 5 seconds
      setTimeout(() => overlay.remove(), 5000);
    }
    
    function updateStats(){
      const t = totalsFor($('#date').value || todayISO());
      $('#dailyTotal').textContent = t.dayTotal;
      $('#weeklyTotal').textContent = t.weekTotal;
      $('#allTimeTotal').textContent = t.all;
      
      // Calculate highest set
      const highestSet = state.entries.length > 0 ? Math.max(...state.entries.map(e => e.reps)) : 0;
      $('#highestSet').textContent = highestSet;
      
      // Calculate average per set
      const avgSet = state.entries.length > 0 ? Math.round(state.entries.reduce((a,b)=>a+b.reps,0) / state.entries.length) : 0;
      $('#avgSet').textContent = avgSet;
      
      // Sets today
      const todayDate = todayISO();
      const setsToday = state.entries.filter(e => e.date === todayDate).length;
      $('#setsToday').textContent = setsToday;
      
      // Target status
      const target = Number($('#dailyTarget').value)||0;
      const pct = target ? Math.round((t.dayTotal/target)*100) : 0;
      const el = $('#targetStatus');
      el.textContent = `${pct}% of target`;
      el.className = 'pill ' + (pct>=120? 'ok' : pct>=80? 'warn' : 'bad');
      
      // Update totals
      $('#totalSets').textContent = state.entries.length;
      $('#totalReps').textContent = state.entries.reduce((a,b)=>a+b.reps,0);
      
      // Update new highest daily/weekly total displays
      $('#highestDailyTotal').textContent = state.highestDailyTotal;
      $('#highestWeeklyTotal').textContent = state.highestWeeklyTotal;

      // Weekly comparison
      updateWeeklyComparison();
    }
    
    // Calculate weekly comparison and update highestWeeklyTotal
    function updateWeeklyComparison(){
      const today = new Date();
      const [thisWeekStart, thisWeekEnd] = wkRange(today.toISOString().slice(0,10));
      
      // Calculate last week range
      const lastWeekDate = new Date(today);
      lastWeekDate.setDate(today.getDate() - 7);
      const [lastWeekStart, lastWeekEnd] = wkRange(lastWeekDate.toISOString().slice(0,10));
      
      // Calculate totals
      const thisWeekTotal = state.entries
        .filter(e => e.date >= thisWeekStart && e.date <= thisWeekEnd)
        .reduce((sum, e) => sum + e.reps, 0);
        
      const lastWeekTotal = state.entries
        .filter(e => e.date >= lastWeekStart && e.date <= lastWeekEnd)
        .reduce((sum, e) => sum + e.reps, 0);
      
      $('#thisWeekTotal').textContent = thisWeekTotal;
      $('#lastWeekTotal').textContent = lastWeekTotal;
      
      const diff = thisWeekTotal - lastWeekTotal;
      const pctChange = lastWeekTotal > 0 ? Math.round((diff / lastWeekTotal) * 100) : 0;
      
      const arrow = $('#trendArrow');
      const comparison = $('#weeklyComparison');
      
      if(diff > 0){
        arrow.textContent = 'üìà';
        arrow.style.color = 'var(--ok)';
        comparison.innerHTML = `<span class="trend up">+${diff} reps (‚Üë${pctChange}%)</span> <span style="color:var(--ok);margin-left:8px">Great progress!</span>`;
      } else if(diff < 0){
        arrow.textContent = 'üìâ';
        arrow.style.color = 'var(--bad)';
        comparison.innerHTML = `<span class="trend down">${diff} reps (‚Üì${Math.abs(pctChange)}%)</span> <span style="color:var(--muted);margin-left:8px">Let's get back on track!</span>`;
      } else {
        arrow.textContent = '‚û°Ô∏è';
        arrow.style.color = 'var(--muted)';
        comparison.innerHTML = `<span class="trend stable">Same as last week</span> <span style="color:var(--muted);margin-left:8px">Stay consistent!</span>`;
      }
      
      // Check for new highest weekly total *after* updating the current week's total
      if (thisWeekTotal > state.highestWeeklyTotal) {
          const oldHighest = state.highestWeeklyTotal;
          state.highestWeeklyTotal = thisWeekTotal;
          if (oldHighest > 0) { // Only celebrate if it's an actual improvement over a previous record
            showAchievement('weekly_pr', thisWeekTotal);
          }
      }
    }

    function render(){
      // inputs
      $('#date').value ||= todayISO();
      $('#dailyTarget').value = state.target;

      // Check if we need full re-render or just stats update
      // Include new state variables in string check
      const stateStr = JSON.stringify(state.entries) + state.highestWeeklyTotal + state.highestDailyTotal; 
      const needsFullRender = stateStr !== lastRenderedState;
      
      if(needsFullRender){
        renderLog();
        lastRenderedState = stateStr;
      }
      
      // Always update stats (fast)
      updateStats();

      const [ws,we] = wkRange($('#date').value || todayISO());
      $('#weekInfo').textContent = `Week: ${ws} ‚Üí ${we}`;
      
      // Update streak badge
      const currentStreak = calculateStreak();
      const streakEl = $('#streakBadge');
      if(currentStreak >= 2){
        streakEl.innerHTML = `<div class="streak-badge"><span class="streak-emoji">üî•</span>${currentStreak} day streak</div>`;
      } else {
        streakEl.innerHTML = '';
      }

      $('#raw').textContent = JSON.stringify(state,null,2);
      
      // Only re-render chart if needed
      if(needsFullRender || !chartInstance){
        renderChart();
      }
      updateTodayBadge();
    }
    
    // Separate log rendering for performance
    function renderLog(){
      const grouped = {};
      state.entries.forEach(e => {
        if(!grouped[e.date]) grouped[e.date] = [];
        grouped[e.date].push(e);
      });

      const dates = Object.keys(grouped).sort((a,b) => b.localeCompare(a));
      dates.forEach(date => {
        grouped[date].sort((a,b) => b.createdAt - a.createdAt);
      });

      const monthGroups = {};
      dates.forEach(date => {
        const monthKey = date.slice(0, 7);
        if(!monthGroups[monthKey]) monthGroups[monthKey] = [];
        monthGroups[monthKey].push(date);
      });

      const months = Object.keys(monthGroups).sort((a,b) => b.localeCompare(a));

      const container = $('#logContainer');
      if(dates.length === 0){
        container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px">No entries yet. Add your first set above!</p>';
      } else {
        container.innerHTML = months.map(monthKey => {
          const monthDates = monthGroups[monthKey];
          const monthName = new Date(monthKey + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
          
          const monthTotalReps = monthDates.reduce((sum, date) => {
            return sum + grouped[date].reduce((s, e) => s + e.reps, 0);
          }, 0);
          const monthTotalSets = monthDates.reduce((sum, date) => sum + grouped[date].length, 0);

          return `
            <div class="month-group">
              <div class="month-header" tabindex="0" role="button" aria-expanded="false" aria-controls="month-${monthKey}" data-month="${monthKey}">
                <div>
                  <strong>${monthName}</strong>
                  <span style="color:var(--muted);margin-left:10px">${monthTotalSets} sets ‚Ä¢ ${monthDates.length} days</span>
                </div>
                <div>
                  <strong style="color:var(--accent)">${monthTotalReps} reps</strong>
                  <span style="margin-left:10px;color:var(--muted)" id="month-arrow-${monthKey}">‚ñº</span>
                </div>
              </div>
              <div class="month-content" id="month-${monthKey}" style="display:none">
                ${monthDates.map(date => {
                  const sets = grouped[date];
                  const dayTotal = sets.reduce((sum, e) => sum + e.reps, 0);
                  const setCount = sets.length;
                  
                  return `
                    <div class="day-group">
                      <div class="day-header" tabindex="0" role="button" aria-expanded="false" aria-controls="sets-${date}" data-date="${date}">
                        <div>
                          <strong>${date}</strong>
                          <span style="color:var(--muted);margin-left:8px">${setCount} set${setCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div>
                          <strong style="color:var(--accent)">${dayTotal} reps</strong>
                          <span style="margin-left:8px;color:var(--muted)" id="arrow-${date}">‚ñº</span>
                        </div>
                      </div>
                      <div class="day-sets" id="sets-${date}" style="display:none">
                        ${sets.map(e => `
                          <div class="set-item">
                            <div class="set-info">
                              <strong>${e.reps} reps</strong>
                              ${e.note ? `<span style="color:var(--muted);margin-left:8px">${e.note}</span>` : ''}
                            </div>
                            <div class="set-actions">
                              <button data-id="${e.id}" class="ghost edit-btn">Edit</button>
                              <button data-id="${e.id}" class="ghost del-btn">Delete</button>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function toggleMonth(monthKey){
      const contentEl = document.getElementById(`month-${monthKey}`);
      const arrowEl = document.getElementById(`month-arrow-${monthKey}`);
      const headerEl = document.querySelector(`[data-month="${monthKey}"]`);
      
      if(contentEl.style.display === 'none'){
        contentEl.style.display = 'block';
        arrowEl.textContent = '‚ñ≤';
        if(headerEl) headerEl.setAttribute('aria-expanded', 'true');
      } else {
        contentEl.style.display = 'none';
        arrowEl.textContent = '‚ñº';
        if(headerEl) headerEl.setAttribute('aria-expanded', 'false');
      }
    }

    function toggleDay(date){
      const setsEl = document.getElementById(`sets-${date}`);
      const arrowEl = document.getElementById(`arrow-${date}`);
      const headerEl = document.querySelector(`[data-date="${date}"]`);
      
      if(setsEl.style.display === 'none'){
        setsEl.style.display = 'block';
        arrowEl.textContent = '‚ñ≤';
        if(headerEl) headerEl.setAttribute('aria-expanded', 'true');
      } else {
        setsEl.style.display = 'none';
        arrowEl.textContent = '‚ñº';
        if(headerEl) headerEl.setAttribute('aria-expanded', 'false');
      }
    }

    function renderChart(){
      const days = Number($('#chartDays').value) || 30;
      const today = new Date();
      const labels = [];
      const data = [];
      
      for(let i = days - 1; i >= 0; i--){
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const dateStr = d.toISOString().slice(0,10);
        labels.push(dateStr);
        
        const dayTotal = state.entries
          .filter(e => e.date === dateStr)
          .reduce((sum, e) => sum + e.reps, 0);
        data.push(dayTotal);
      }

      const ctx = $('#chart').getContext('2d');
      
      if(chartInstance){
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Daily Push-ups',
              data: data,
              borderColor: '#4f8cff',
              backgroundColor: 'rgba(79, 140, 255, 0.1)',
              tension: 0.3,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'Target',
              data: Array(labels.length).fill(state.target),
              borderColor: '#22c55e',
              borderDash: [5, 5],
              borderWidth: 2,
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#e7e7ea' }
            },
            tooltip: {
              backgroundColor: '#151517',
              titleColor: '#e7e7ea',
              bodyColor: '#e7e7ea',
              borderColor: '#222',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              ticks: { 
                color: '#9aa0a6',
                maxRotation: 45,
                minRotation: 45
              },
              grid: { color: '#222' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#9aa0a6' },
              grid: { color: '#222' }
            }
          }
        }
      });
    }
    
    // Modal for editing
    function showEditModal(entryId){
      const entry = state.entries.find(x => x.id === entryId);
      if(!entry) return;
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal" role="dialog" aria-labelledby="editModalTitle" aria-modal="true">
          <h3 id="editModalTitle">Edit Set</h3>
          <label>Reps</label>
          <input type="number" id="editReps" value="${entry.reps}" min="1" aria-label="Number of reps" />
          <label>Notes</label>
          <textarea id="editNote" aria-label="Set notes">${entry.note || ''}</textarea>
          <div class="modal-buttons">
            <button class="ghost" id="cancelEdit">Cancel</button>
            <button class="primary" id="saveEdit">Save</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const saveBtn = overlay.querySelector('#saveEdit');
      const cancelBtn = overlay.querySelector('#cancelEdit');
      const repsInput = overlay.querySelector('#editReps');
      
      // Focus first input
      repsInput.focus();
      repsInput.select();
      
      // Save function
      const handleSave = () => {
        const reps = Number(repsInput.value);
        const note = overlay.querySelector('#editNote').value.trim();
        
        if(!reps || reps < 1){
          console.error('Please enter valid reps'); 
          return;
        }
        
        // Update state object, then save
        const newState = { ...state };
        const entryToUpdate = newState.entries.find(x => x.id === entryId);
        if(entryToUpdate){
            entryToUpdate.reps = reps;
            entryToUpdate.note = note;
        }
        
        saveState(newState);
        overlay.remove();
      };
      
      saveBtn.addEventListener('click', handleSave);
      cancelBtn.addEventListener('click', () => overlay.remove());
      
      // Keyboard shortcuts
      overlay.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          overlay.remove();
        } else if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
          handleSave();
        }
      });
      
      overlay.addEventListener('click', (e) => {
        if(e.target === overlay) overlay.remove();
      });
    }

    // --- Events and Handlers ---

    // Keyboard shortcuts - global
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K to focus reps input
      if((e.ctrlKey || e.metaKey) && e.key === 'k'){
        e.preventDefault();
        $('#reps').focus();
        $('#reps').select();
      }
      
      // Escape to clear inputs
      if(e.key === 'Escape' && document.activeElement.id === 'reps'){
        $('#reps').value = '';
        $('#note').value = '';
        $('#reps').blur();
      }
    });
    
    // Keyboard navigation for collapsible sections
    document.addEventListener('keydown', (e) => {
      const target = e.target;
      
      // Month headers
      if(target.classList.contains('month-header')){
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          const monthKey = target.getAttribute('data-month');
          toggleMonth(monthKey);
        }
      }
      
      // Day headers
      if(target.classList.contains('day-header')){
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          const date = target.getAttribute('data-date');
          toggleDay(date);
        }
      }
    });
    
    $('#addBtn').addEventListener('click', () => {
      if(!isStorageReady) return console.warn("Storage not ready");

      const date = $('#date').value || todayISO();
      const reps = Number($('#reps').value);
      if(!reps || reps < 1) return console.error('Enter reps');
      
      const note = $('#note').value.trim();
      const entry = { id: crypto.randomUUID(), date, reps, note, createdAt: Date.now() };
      
      // Check for achievements before adding
      const oldTotal = state.entries.reduce((a,b)=>a+b.reps,0);
      const oldTodayTotal = state.entries.filter(e=>e.date===date).reduce((a,b)=>a+b.reps,0);
      const oldHighestSet = state.entries.length > 0 ? Math.max(...state.entries.map(e => e.reps)) : 0;
      
      const newState = { ...state, entries: [...state.entries, entry] };
      
      // Update PRs that rely on historical or current data
      calculateHighestDailyTotal(newState.entries);
      updateWeeklyComparison(); 
      // saveState is now synchronous (note: PR calculation functions mutate state)
      saveState(newState); 
      
      $('#reps').value = '';
      $('#note').value = '';
      $('#reps').focus();
      
      // Check achievements after adding
      const newTodayTotal = oldTodayTotal + reps;
      const target = Number($('#dailyTarget').value)||0;
      
      // Target achieved
      if(target > 0 && oldTodayTotal < target && newTodayTotal >= target){
        showAchievement('target', target);
      }
      
      // New personal record (Highest Set)
      if(reps > oldHighestSet){
        showAchievement('pr', reps);
      }
      
      // New personal record (Highest Daily Total)
      if(newTodayTotal > state.highestDailyTotal){
         showAchievement('daily_pr', newTodayTotal);
         // Note: state.highestDailyTotal was updated by calculateHighestDailyTotal
      }
      
      // New streak milestone (every 5 days)
      const oldStreak = calculateStreak(); // Calculate before saveState was synchronous, now calculate after, relying on render to use the current state
      const newStreak = calculateStreak(); 
      if(newStreak > oldStreak && newStreak >= 5 && newStreak % 5 === 0){
        showAchievement('streak', newStreak);
      }
      
      // Total reps milestones
      const newTotal = oldTotal + reps;
      const milestones = [100, 250, 500, 1000, 2500, 5000, 10000];
      for(const milestone of milestones){
        if(oldTotal < milestone && newTotal >= milestone){
          showAchievement('milestone', milestone);
          break;
        }
      }
    });
    
    // Enter key to add set
    $('#reps').addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        $('#addBtn').click();
      }
    });
    
    $('#note').addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        $('#addBtn').click();
      }
    });

    function updateTodayBadge(){
      const t = totalsFor(todayISO());
      $('#todayTotal').textContent = `Today: ${t.dayTotal}`;
    }

    $('#clearTodayBtn').addEventListener('click', () => {
      if(!isStorageReady) return;
      
      const d = $('#date').value || todayISO();
      const showClearConfirm = () => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          overlay.innerHTML = `
            <div class="modal" role="dialog" aria-labelledby="clearModalTitle" aria-modal="true">
              <h3 id="clearModalTitle" style="color:var(--bad)">Confirm Clear</h3>
              <p>Are you sure you want to delete all entries for ${d}?</p>
              <div class="modal-buttons">
                <button class="ghost" id="cancelClear">Cancel</button>
                <button class="danger" id="confirmClear">Delete All</button>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);

          overlay.querySelector('#confirmClear').addEventListener('click', () => {
            const newState = { 
              ...state, 
              entries: state.entries.filter(e => e.date !== d) 
            };
            // saveState is now synchronous
            saveState(newState); 
            overlay.remove();
          });
          overlay.querySelector('#cancelClear').addEventListener('click', () => overlay.remove());
          overlay.addEventListener('click', (e) => {
            if(e.target === overlay) overlay.remove();
          });
        };
        showClearConfirm();
    });

    $('#dailyTarget').addEventListener('change', () => {
      if(!isStorageReady) return;
      
      const target = Number($('#dailyTarget').value)||0;
      const newState = { ...state, target: target };
      // saveState is now synchronous
      saveState(newState); 
    });
    
    // Debounce target input for better performance
    let targetDebounce = null;
    $('#dailyTarget').addEventListener('input', () => {
      if(!isStorageReady) return;
      
      if(targetDebounce) clearTimeout(targetDebounce);
      targetDebounce = setTimeout(() => {
        const target = Number($('#dailyTarget').value)||0;
        const newState = { ...state, target: target };
        // saveState is now synchronous
        saveState(newState); 
      }, 500);
    });

    $('#logContainer').addEventListener('click', (e) => {
      if(!isStorageReady) return;

      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      
      if(btn.classList.contains('del-btn')){
        const showDeleteConfirm = () => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          overlay.innerHTML = `
            <div class="modal" role="dialog" aria-labelledby="deleteModalTitle" aria-modal="true">
              <h3 id="deleteModalTitle" style="color:var(--bad)">Confirm Deletion</h3>
              <p>Are you sure you want to permanently delete this set?</p>
              <div class="modal-buttons">
                <button class="ghost" id="cancelDelete">Cancel</button>
                <button class="danger" id="confirmDelete">Delete</button>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);

          overlay.querySelector('#confirmDelete').addEventListener('click', () => {
            const newState = { 
              ...state, 
              entries: state.entries.filter(x => x.id !== id) 
            };
            // saveState is now synchronous
            saveState(newState); 
            overlay.remove();
          });
          overlay.querySelector('#cancelDelete').addEventListener('click', () => overlay.remove());
          overlay.addEventListener('click', (e) => {
            if(e.target === overlay) overlay.remove();
          });
        };
        showDeleteConfirm();
      }
      
      if(btn.classList.contains('edit-btn')){
        showEditModal(id);
      }
    });

    $('#expandAllBtn').addEventListener('click', () => {
      document.querySelectorAll('.month-content').forEach(el => {
        el.style.display = 'block';
      });
      document.querySelectorAll('[id^="month-arrow-"]').forEach(el => {
        el.textContent = '‚ñ≤';
      });
      document.querySelectorAll('.day-sets').forEach(el => {
        el.style.display = 'block';
      });
      document.querySelectorAll('[id^="arrow-"]').forEach(el => {
        el.textContent = '‚ñ≤';
      });
    });

    $('#collapseAllBtn').addEventListener('click', () => {
      document.querySelectorAll('.month-content').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('[id^="month-arrow-"]').forEach(el => {
        el.textContent = '‚ñº';
      });
      document.querySelectorAll('.day-sets').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('[id^="arrow-"]').forEach(el => {
        el.textContent = '‚ñº';
      });
    });

    // Export/Import/Reset
    $('#exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pushup-tracker-backup.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#importBtn').addEventListener('click', async () => {
      if(!isStorageReady) return;
      
      const f = $('#importFile').files[0];
      if(!f) return console.error('Choose a JSON file first');
      
      const text = await f.text();
      try{
        const data = JSON.parse(text);
        
        // Validate imported data
        if(!data || typeof data !== 'object' || !Array.isArray(data.entries)){
          throw new Error('Invalid file format or missing entries array.');
        }
        
        // Validate each entry has required fields
        for(const entry of data.entries){
          if(!entry.id || !entry.date || typeof entry.reps !== 'number'){
            throw new Error('Invalid entry format in file');
          }
        }
        
        // Prepare new state object, ensuring new fields are present
        const newState = { 
          entries: data.entries, 
          target: Number(data.target) || 30,
          lastStreak: data.lastStreak || 0,
          highestWeeklyTotal: Number(data.highestWeeklyTotal) || 0,
          highestDailyTotal: Number(data.highestDailyTotal) || 0, // Include daily total in import
        };

        // saveState is now synchronous
        saveState(newState); 
        
        const successOverlay = document.createElement('div');
        successOverlay.className = 'modal-overlay';
        successOverlay.innerHTML = `
          <div class="modal" style="text-align:center">
            <div style="font-size:48px;margin-bottom:16px">‚úî</div>
            <!-- Updated success message -->
            <h3>Import Successful</h3>
            <p style="color:var(--muted);margin:16px 0">Data imported and saved to local storage.</p>
            <button class="primary" onclick="this.closest('.modal-overlay').remove()">OK</button>
          </div>
        `;
        document.body.appendChild(successOverlay);
        setTimeout(() => successOverlay.remove(), 3000);
        
      }catch(err){ 
        console.error('Import failed:', err);
        const errorOverlay = document.createElement('div');
        errorOverlay.className = 'modal-overlay';
        errorOverlay.innerHTML = `
          <div class="modal" style="text-align:center">
            <h3 style="color:var(--bad)">Import Failed</h3>
            <p style="color:var(--muted);margin:16px 0">${err.message || 'An unknown error occurred during import.'}</p>
            <button class="primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
          </div>
        `;
        document.body.appendChild(errorOverlay);
      }
    });

    // ADDED: Manual backup trigger
    $('#backupBtn').addEventListener('click', async () => {
      $('#backupBtn').textContent = 'Sending...';
      $('#backupBtn').disabled = true;

      try {
          const response = await sendBackupEmail();
          if (response.status === 200) {
              alertMessage('Backup Success', 'Your push-up data has been successfully emailed.', 'ok');
          } else if (response.status === 400 && response.text === 'Skipped - Not Configured') {
              alertMessage('Backup Skipped', 'EmailJS is not configured. Please ensure your keys are correct.', 'warn');
          } else {
              alertMessage('Backup Failed', 'An error occurred during email transmission. Check console for details.', 'bad');
          }
      } catch (e) {
          alertMessage('Backup Failed', 'An unexpected error occurred.', 'bad');
      } finally {
          $('#backupBtn').textContent = 'Manual Email Backup';
          $('#backupBtn').disabled = false;
      }
    });

    $('#resetBtn').addEventListener('click', () => {
      if(!isStorageReady) return;
      
      // Show warning modal with double confirmation
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const totalReps = state.entries.reduce((a,b)=>a+b.reps,0);

      overlay.innerHTML = `
        <div class="modal">
          <h3 style="color:var(--bad)">‚ö†Ô∏è Reset All Data</h3>
          <div class="warning-banner">
            <div>
              <!-- Updated warning message -->
              <strong>Warning:</strong> This will permanently delete all your push-up data (${state.entries.length} sets, ${totalReps} reps) from local storage.
            </div>
          </div>
          <p style="color:var(--muted);margin:16px 0">This action cannot be undone. We recommend exporting your data first.</p>
          <label style="display:flex;align-items:center;gap:8px;margin:20px 0;cursor:pointer">
            <input type="checkbox" id="confirmReset" style="width:auto;margin:0" />
            <span>I understand this will delete all my data</span>
          </label>
          <div class="modal-buttons">
            <button class="ghost" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="primary export-trigger" type="button">Export First</button>
            <button class="danger" id="confirmResetBtn" disabled>Delete Everything</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const checkbox = overlay.querySelector('#confirmReset');
      const confirmBtn = overlay.querySelector('#confirmResetBtn');
      
      checkbox.addEventListener('change', () => {
        confirmBtn.disabled = !checkbox.checked;
      });
      
      overlay.querySelector('.export-trigger').addEventListener('click', (e) => {
        e.preventDefault();
        $('#exportBtn').click();
      });
      
      confirmBtn.addEventListener('click', () => {
        // Reset state to empty defaults and save to storage
        const newState = { entries: [], target: 30, lastStreak: 0, highestWeeklyTotal: 0, highestDailyTotal: 0 };
        // saveState is now synchronous
        saveState(newState); 
        
        overlay.remove();
        
        // Show confirmation
        const successOverlay = document.createElement('div');
        successOverlay.className = 'modal-overlay';
        successOverlay.innerHTML = `
          <div class="modal" style="text-align:center">
            <div style="font-size:48px;margin-bottom:16px">‚úî</div>
            <!-- Updated success message -->
            <h3>Data Reset Complete</h3>
            <p style="color:var(--muted);margin:16px 0">All data has been deleted from local storage.</p>
            <button class="primary" onclick="this.closest('.modal-overlay').remove()">OK</button>
          </div>
        `;
        document.body.appendChild(successOverlay);
        setTimeout(() => successOverlay.remove(), 3000);
      });
      
      overlay.addEventListener('click', (e) => {
        if(e.target === overlay) overlay.remove();
      });
    });

    $('#chartDays').addEventListener('change', () => {
      renderChart();
    });

    // --- Init ---
    initApp();
    $('#date').value = todayISO();

    // Event delegation for month/day toggles
    document.getElementById('logContainer').addEventListener('click', (e) => {
        if (e.target.classList.contains('month-header')) {
            const monthKey = e.target.getAttribute('data-month');
            if (monthKey) toggleMonth(monthKey);
        } else if (e.target.classList.contains('day-header')) {
            const date = e.target.getAttribute('data-date');
            if (date) toggleDay(date);
        }
    });

  </script>
</body>
</html>