<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exercise Tracker (Cloud)</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b0b0c'/%3E%3Crect x='8' y='30' width='48' height='8' rx='4' fill='%23f97316'/%3E%3Ccircle cx='20' cy='24' r='6' fill='%23fbbf24'/%3E%3C/svg%3E">
  <style>
    /* --- CSS STYLES --- */
    :root { --bg:#0b0b0c; --fg:#e7e7ea; --muted:#9aa0a6; --card:#151517; --accent:#4f8cff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    html,body{height:100%}
    body{margin:0;font:18px "Century Gothic", CenturyGothic, AppleGothic, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;background:var(--bg);color:var(--fg);display:flex;flex-direction:column}
    header{padding:24px 32px;border-bottom:1px solid #222;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    header h1{font-size:20px;margin:0;letter-spacing:.3px}
    
    main{
      width: 100%; max-width: 1600px; margin: 0 auto; padding: 32px;
      display: grid; gap: 24px; grid-template-columns: 1fr; 
    }
    
    @media (min-width: 1024px) {
        main {
            grid-template-columns: 350px 1fr;
            grid-template-areas: "addset chart" "prs chart" "prs summary";
        }
        #addEntrySection { grid-area: addset; }
        #prSection { grid-area: prs; display: flex; flex-direction: column; }
        #chartSection { grid-area: chart; }
        #summarySection { grid-area: summary; }
    }
    @media (min-width: 768px) and (max-width: 1023px) { main { grid-template-columns: 1fr 1fr; } }

    .card{background:var(--card);border:1px solid #222;border-radius:16px;padding:24px}
    .card h2{font-size:22px;margin:0 0 16px}
    
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:8px;font-weight:500;}
    input,select,button,textarea{background:#0f1012;color:var(--fg);border:1px solid #2a2b2f;border-radius:12px;padding:14px 16px;font:inherit;font-size:16px; width: 100%; box-sizing: border-box;}
    input[type=date]{padding:.7rem}
    button{cursor:pointer;font-weight:500;transition: opacity 0.2s}
    button:disabled{opacity: 0.5; cursor: not-allowed;}
    button.primary{background:var(--accent);border-color:var(--accent);color:white}
    button.ghost{background:transparent}
    button.danger{background:var(--bad);border-color:var(--bad);color:white}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .pill{font-size:15px;padding:8px 14px;border-radius:999px;border:1px solid #2b2c30;color:var(--muted);font-weight:500}
    
    /* Progress & Stats */
    #targetBar{transition:width 0.35s ease,background 0.25s ease;height:100%;border-radius:3px;background:linear-gradient(90deg,#3b82f6,#1d4ed8)} 
    .progress-wrapper{display:flex;flex-direction:column;gap:6px;width:100%}
    .progress-container{height:18px;background:#2b2c30;border-radius:9px;overflow:hidden;position:relative}
    .progress-inner{height:100%;width:0%;border-radius:9px;}
    .target-pill{font-size:18px;padding:6px 10px;align-self:flex-start}

    /* PR Items */
    .pr-stack{display:flex;flex-direction: column;gap: 12px;}
    .pr-item {padding: 12px 16px;background: #0f1012;border-radius: 10px;display: flex;justify-content: space-between;align-items: center;}
    .pr-label {font-size: 15px;color: var(--fg);font-weight: 500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:10px}
    .pr-value {text-align: right;font-weight: 600;font-size: 18px;color: var(--ok); flex-shrink:0}
    .pr-date {display: block;font-size: 13px;color: var(--muted);font-weight: 400;margin-top: 2px;}
    .spacer{height:2px;background:#1b1b1e;margin:12px 0}

    /* Modals & Celebrations */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal{background:var(--card);border:1px solid #333;border-radius:16px;padding:32px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
    .modal-buttons{display:flex;gap:12px;margin-top:24px;justify-content:flex-end}
    .celebration{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border:2px solid var(--ok);border-radius:20px;padding:40px;text-align:center;z-index:2000;animation:popIn 0.3s ease-out}
    .celebration .emoji{display:inline-block;font-size:64px;margin-bottom:16px;}
    @keyframes popIn{from{transform:translate(-50%,-50%) scale(0.8);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}

    /* Logs & History */
    .month-group{margin-bottom:20px;border:1px solid #333;border-radius:12px;overflow:hidden}
    .month-header{padding:18px 24px;background:#1f1f21;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;font-size:19px}
    .month-content{padding:16px;background:var(--bg)}
    .day-group{margin-bottom:16px;border:1px solid #222;border-radius:10px;overflow:hidden}
    .day-header{padding:14px 20px;background:#1a1a1c;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;font-size:16px}
    .day-sets{padding:12px;background:var(--card)}
    .set-item{padding:14px 16px;margin:8px 0;background:#0f1012;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:16px;font-size:16px}
    .set-info{flex:1}
    .set-actions{display:flex;gap:10px}
    .set-actions button{padding:6px 12px;font-size:13px}

    /* Summary Grid */
    #summarySection .summary-grid{display:grid;grid-template-columns:1fr 1fr 280px;gap:12px;align-items:stretch;flex:1}
    @media (max-width: 900px){ #summarySection .summary-grid{grid-template-columns:1fr;gap:12px} }
    #summarySection .summary-left{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;grid-column:1/3;}
    #summarySection .stat-card{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:12px;background:#0f1012;border-radius:8px;min-height:100px}
    #summarySection .stat-card label{font-size:16px;color:var(--fg);margin-bottom:8px;text-align:center;font-weight:500}
    #summarySection .stat-card .value{font-size:44px;font-weight:700;line-height:1}
    #summarySection .summary-right{display:flex;flex-direction:column;gap:12px}
    #summarySection .control-card{display:flex;flex-direction:column;padding:12px;background:#0f1012;border-radius:8px;flex:1}

    .streak-badge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#f59e0b,#ef4444);padding:10px 16px;border-radius:12px;font-weight:600;color:white;font-size:16px}
    
    /* Mobile tweaks */
    @media (max-width: 480px) {
      main { padding: 16px; grid-template-columns: 1fr; }
      header { position: sticky; top: 0; z-index: 60; background: rgba(11,11,12,0.95); }
      .row > * { flex: 1 1 100%; }
      #chart { height: 250px !important; }
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:16px">
      <h4>Stronger Every Press</h4>
      <span class="pill" id="storageInfo" style="color:var(--ok);border-color:var(--ok)">Supabase Cloud</span>
      <div id="streakBadge"></div>
    </div>
    <div style="margin-left:auto" class="pill" id="weekInfo">Week: ‚Äî</div>
  </header>

  <main id="appContent">
    <div id="loadingIndicator" style="text-align:center;padding:50px;font-size:20px;color:var(--muted)">
      Connecting to your database...
    </div>
    
    <section class="card" id="addEntrySection" style="display:none">
      <div style="margin-bottom: 24px;">
        <label for="exerciseSelect" style="font-size: 22px; font-weight: bold; color: var(--fg);">Exercise</label>
        <select id="exerciseSelect" style="font-size: 16px;">
          <option value="Push-up" selected>Push-up</option>
          <option value="Abs">Abs</option>
          <option value="Squat">Squat</option>
          <option value="Crab/Bear Walk">Crab/Bear Walk</option>
        </select>
      </div>

      <div style="margin-bottom: 16px;">
        <label for="type">Type</label>
        <select id="type" aria-label="Set Type"></select>
      </div>
      
      <h2 style="margin-top: 16px;">Add Set</h2>
      <div>
        <div style="margin-bottom: 16px;">
          <label for="date">Date</label>
          <div style="position:relative;display:flex;align-items:center;">
            <input id="date" type="text" class="date-picker" placeholder="Select date" style="width:100%;padding-right:40px;">
            <span id="calendarIcon" role="button" style="position:absolute;right:12px;cursor:pointer;font-size:20px;color:var(--muted);">üìÖ</span>
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label for="reps">Reps</label>
          <input id="reps" type="number" min="1" inputmode="numeric" placeholder="e.g. 20" />
        </div>
        <div style="margin-bottom: 16px;">
          <label for="note">Notes</label>
          <input id="note" type="text" placeholder="e.g. tricep, incline" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="addBtn">Add Set</button>
      </div>
      
      <div id="todayLogPanel" style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #333; display: none;">
          <h3 style="font-size: 18px; margin: 0 0 12px; color: var(--fg);">Sets for Selected Date</h3>
          <div id="todayLogList" style="display: flex; flex-direction: column; gap: 8px;"></div>
      </div>
    </section>
    
    <section class="card" id="prSection" style="display:none">
        <h2>Personal Records</h2>
        <div class="pr-stack">
            <div class="pr-item">
              <span class="pr-label">Max Set üí™</span>
              <div class="pr-value" id="highestSet">0 <span class="pr-date">‚Äî</span></div>
            </div>
            <div class="pr-item">
              <span class="pr-label">Max Day üöÄ</span>
              <div class="pr-value" id="highestDailyTotal">0 <span class="pr-date">‚Äî</span></div>
            </div>
            <div class="pr-item">
              <span class="pr-label">Max Week üèÜ</span>
              <div class="pr-value" id="highestWeeklyTotal">0 <span class="pr-date">‚Äî</span></div>
            </div>
        </div>
        <div class="spacer"></div>
        <div class="pr-stack" id="type-pr-list-container"></div>
    </section>

    <section class="card" id="chartSection" style="display:none">
      <h2>Progress Chart</h2>
      <div style="position:relative;height:400px">
        <canvas id="chart"></canvas>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="chartDays">Show last</label>
          <select id="chartDays">
            <option value="7">7 days</option>
            <option value="14">14 days</option>
            <option value="30" selected>30 days</option>
            <option value="90">90 days</option>
          </select>
        </div>
      </div>

      <div class="spacer" style="margin-top: 24px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0;font-size:20px">History</h3>
          <div style="display:flex;gap:8px">
              <button id="expandAllBtn" class="ghost">Expand All</button>
              <button id="collapseAllBtn" class="ghost">Collapse All</button>
          </div>
      </div>
      <div id="logContainer"></div>
    </section>

    <section class="card" id="summarySection" style="display:none">
      <h2>Summary & Goals</h2>
      <div class="summary-grid">
        <div class="summary-left">
          <div class="stat-card">
            <label>Daily Total</label>
            <div class="value" id="dailyTotal">0</div>
          </div>
          <div class="stat-card">
            <label>Weekly Total</label>
            <div class="value" id="weeklyTotal">0</div>
          </div>
          <div class="stat-card">
            <label>Sets Today</label>
            <div class="value" id="setsToday">0</div>
          </div>
          <div class="stat-card">
            <label>Avg Per Set</label>
            <div class="value" id="avgSet">0</div>
          </div>
          <div class="stat-card">
            <label>All-time Total</label>
            <div class="value" id="allTimeTotal">0</div>
          </div>
          <div class="stat-card">
            <label>Weekly Average</label>
            <div class="value" id="weeklyAvg">0</div>
          </div>
        </div>

        <div class="summary-right">
          <div class="control-card">
            <label for="dailyTarget">Daily Target</label>
            <input id="dailyTarget" type="number" min="0" value="30" />
            <div class="progress-wrapper">
              <span class="pill target-pill" id="targetStatus">0%</span>
              <div class="progress-container">
                <div id="targetBar" class="progress-inner"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script type="module">
    // --- 1. SUPABASE CREDENTIALS ---
    const SUPABASE_URL = 'https://rwfzdnprseuizzgygeow.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3ZnpkbnByc2V1aXp6Z3lnZW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMDUzMDksImV4cCI6MjA4MTU4MTMwOX0.K00q1xtHtC4piuacViSqlAOV26xtPRqshcTxFsGBDKk';
    
    // Initialize Client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. CONFIG & STATE ---
    const EXERCISE_CONFIG = {
        'Push-up': {
            types: ['Standard', 'Wide', 'Narrow', 'Inside', 'Reverse - Table', 'One-Leg', 'Other'],
            prDefinitions: { 
                'Standard': { key: 'pr_standard', label: 'Max Standard' }, 
                'Wide': { key: 'pr_wide', label: 'Max Wide' },
                'Narrow': { key: 'pr_narrow', label: 'Max Narrow' }
            },
            defaultTarget: 30
        },
        'Abs': { 
            types: ['Ab Wheel', 'Sit-up Secured', 'Plank (seconds)', 'Russian Twists', 'Scissors'], 
            prDefinitions: { 'Ab Wheel': { key: 'pr_abwheel', label: 'Max Ab Wheel' } },
            defaultTarget: 50
        },
        'Squat': { 
            types: ['Bodyweight', 'Goblet Squat', 'Back Squat'], 
            prDefinitions: { 'Back Squat': { key: 'pr_backsquat', label: 'Max Back Squat'} }, 
            defaultTarget: 50 
        },
        'Crab/Bear Walk': { 
            types: ['Crab Walk', 'Bear Walk'], 
            prDefinitions: {}, 
            defaultTarget: 60 
        }
    };
    
    let currentExercise = 'Push-up';
    let allEntries = []; // Holds EVERYTHING
    let chartInstance = null;
    let currentTarget = 30;
    const defaultPR = { reps: 0, date: '‚Äî' };
    
    const $ = sel => document.querySelector(sel);
    
    // --- 3. CORE LOGIC ---

    async function fetchData() {
        setLoading(true);
        const { data, error } = await supabase.from('pushup_logs').select('*').order('created_at', { ascending: true });
        
        if (error) {
            console.error(error);
            alert('Cloud Error: ' + error.message);
        } else {
            allEntries = data || [];
            
            // --- AUTO-FIX LEGACY DATA ---
            // If exercise is null, look at the "Type" to guess the Exercise
            allEntries.forEach(e => {
                if(!e.exercise) {
                    // Try to find which exercise this type belongs to
                    const foundExercise = Object.keys(EXERCISE_CONFIG).find(exName => 
                        EXERCISE_CONFIG[exName].types.includes(e.type)
                    );
                    e.exercise = foundExercise || 'Push-up'; // Fallback to Push-up if unknown
                }
            });

            render();
        }
        setLoading(false);
    }

    async function addEntry() {
        const date = $('#date').value;
        const reps = Number($('#reps').value);
        const type = $('#type').value;
        const note = $('#note').value;
        
        if(!reps || reps < 1) return alert("Please enter valid reps");

        // Filter for calculation context
        const currentFiltered = allEntries.filter(e => e.exercise === currentExercise);
        const oldStats = calculateAllStats(currentFiltered);
        const oldStreak = calculateStreak(currentFiltered);

        // SAVE TO SUPABASE
        const { data, error } = await supabase
            .from('pushup_logs')
            .insert([{ date, reps, type, note, exercise: currentExercise }])
            .select();

        if (error) {
            alert('Error saving: ' + error.message);
        } else if (data && data.length) {
            allEntries.push(data[0]);
            
            // Check Achievements
            const newFiltered = allEntries.filter(e => e.exercise === currentExercise);
            const newStats = calculateAllStats(newFiltered);
            const newStreak = calculateStreak(newFiltered);
            
            checkAchievements(oldStats, newStats, oldStreak, newStreak, reps, type);
            
            render();
            $('#reps').value = '';
            $('#note').value = '';
        }
    }

    async function deleteEntry(id) {
        if(!confirm("Delete this set?")) return;
        const { error } = await supabase.from('pushup_logs').delete().eq('id', id);
        if(!error) {
            allEntries = allEntries.filter(e => e.id !== id);
            render();
        } else {
            alert(error.message);
        }
    }

    async function updateEntry(id, newReps, newType, newNote, newExercise) {
        const { error } = await supabase.from('pushup_logs')
            .update({ reps: newReps, type: newType, note: newNote, exercise: newExercise })
            .eq('id', id);

        if(!error) {
            const idx = allEntries.findIndex(e => e.id === id);
            if(idx !== -1) {
                allEntries[idx].reps = newReps;
                allEntries[idx].type = newType;
                allEntries[idx].note = newNote;
                allEntries[idx].exercise = newExercise;
            }
            render();
        } else {
            alert(error.message);
        }
    }

    // --- 4. CALCULATIONS ---

    function calculateStreak(data) {
        if(data.length === 0) return 0;
        const uniqueDates = [...new Set(data.map(e => e.date))].sort().reverse();
        const today = new Date().toISOString().slice(0,10);
        let streak = 0;
        let checkDate = today;

        if(uniqueDates[0] === today) {
            streak = 1;
            checkDate = prevDay(today);
        } else if (uniqueDates[0] === prevDay(today)) {
             checkDate = prevDay(today); 
        } else {
            return 0; 
        }
        
        for(let i=0; i<uniqueDates.length; i++) {
             if (uniqueDates[i] === new Date().toISOString().slice(0,10) && streak === 1) continue;
             if (uniqueDates[i] === checkDate) {
                 if(uniqueDates[i] !== new Date().toISOString().slice(0,10)) streak++;
                 checkDate = prevDay(checkDate);
             }
        }
        return streak;
    }
    
    function prevDay(dateStr) {
        const d = new Date(dateStr);
        d.setDate(d.getDate() - 1);
        return d.toISOString().slice(0,10);
    }
    
    function wkRange(dateStr) {
        const dt = new Date(dateStr);
        const day = (dt.getDay()+6)%7;
        const mon = new Date(dt); mon.setDate(dt.getDate()-day);
        const sun = new Date(mon); sun.setDate(mon.getDate()+6);
        return [mon.toISOString().slice(0,10), sun.toISOString().slice(0,10)];
    }

    function calculateAllStats(data) {
        const stats = {
            totalReps: 0,
            setsToday: 0,
            pr_set: { ...defaultPR },
            pr_day: { ...defaultPR },
            pr_week: { ...defaultPR },
            type_prs: {},
            dailyTotals: {},
            weeklyTotals: {}
        };

        const config = EXERCISE_CONFIG[currentExercise];
        
        data.forEach(e => {
            stats.totalReps += e.reps;
            
            // Max Set
            if(e.reps > stats.pr_set.reps) stats.pr_set = { reps: e.reps, date: e.date };
            
            // Type PRs
            const prKey = config.prDefinitions[e.type]?.key;
            if (prKey) {
                if (!stats.type_prs[prKey]) stats.type_prs[prKey] = { ...defaultPR };
                if (e.reps > stats.type_prs[prKey].reps) stats.type_prs[prKey] = { reps: e.reps, date: e.date };
            }

            // Maps
            stats.dailyTotals[e.date] = (stats.dailyTotals[e.date] || 0) + e.reps;
            const weekKey = wkRange(e.date)[0];
            stats.weeklyTotals[weekKey] = (stats.weeklyTotals[weekKey] || 0) + e.reps;
        });

        for (const [d, t] of Object.entries(stats.dailyTotals)) {
            if (t > stats.pr_day.reps) stats.pr_day = { reps: t, date: d };
        }
        for (const [w, t] of Object.entries(stats.weeklyTotals)) {
            if (t > stats.pr_week.reps) stats.pr_week = { reps: t, date: w };
        }
        
        return stats;
    }

    // --- 5. RENDER UI ---

    function render() {
        const dateInput = $('#date').value || new Date().toISOString().slice(0,10);
        
        // Filter entries based on currentExercise
        const filteredEntries = allEntries.filter(e => e.exercise === currentExercise);

        const stats = calculateAllStats(filteredEntries);
        const streak = calculateStreak(filteredEntries);

        // Update Headers & Targets
        $('#streakBadge').innerHTML = streak > 1 ? `<div class="streak-badge">üî• ${streak} day streak</div>` : '';
        $('#addEntrySection label[for="exerciseSelect"]').textContent = `Exercise: ${currentExercise}`;

        // Stats
        $('#highestSet').innerHTML = `${stats.pr_set.reps} <span class="pr-date">${stats.pr_set.date}</span>`;
        $('#highestDailyTotal').innerHTML = `${stats.pr_day.reps} <span class="pr-date">${stats.pr_day.date}</span>`;
        $('#highestWeeklyTotal').innerHTML = `${stats.pr_week.reps} <span class="pr-date">${stats.pr_week.date}</span>`;
        
        // PR List
        const config = EXERCISE_CONFIG[currentExercise];
        const prContainer = $('#type-pr-list-container');
        prContainer.innerHTML = '';
        if(config.prDefinitions) {
            Object.entries(config.prDefinitions).forEach(([type, def]) => {
                const pr = stats.type_prs[def.key] || defaultPR;
                prContainer.innerHTML += `
                    <div class="pr-item">
                        <span class="pr-label">${def.label}</span>
                        <div class="pr-value">${pr.reps} <span class="pr-date">${pr.date}</span></div>
                    </div>`;
            });
        }

        // Summary
        const todayTotal = stats.dailyTotals[dateInput] || 0;
        const weekStart = wkRange(dateInput)[0];
        const currentWeekTotal = stats.weeklyTotals[weekStart] || 0;

        $('#dailyTotal').textContent = todayTotal;
        $('#weeklyTotal').textContent = currentWeekTotal;
        $('#allTimeTotal').textContent = stats.totalReps;
        $('#setsToday').textContent = filteredEntries.filter(e => e.date === dateInput).length;
        $('#avgSet').textContent = stats.setsToday > 0 ? Math.round(todayTotal / stats.setsToday) : 0;
        $('#weeklyAvg').textContent = Object.keys(stats.weeklyTotals).length > 0 
             ? Math.round(stats.totalReps / Object.keys(stats.weeklyTotals).length) : 0;

        // Target
        const pct = Math.min(100, Math.round((todayTotal / currentTarget) * 100));
        $('#targetStatus').textContent = `${pct}%`;
        $('#targetBar').style.width = `${pct}%`;
        $('#targetStatus').className = `pill target-pill ${pct >= 100 ? 'ok' : 'warn'}`;
        
        // Pass Filtered Entries to sub-renders
        renderTodayLog(filteredEntries, dateInput);
        renderFullHistory(filteredEntries);
        renderChart(filteredEntries);
    }

    function renderTodayLog(data, date) {
        const todayEntries = data.filter(e => e.date === date).reverse();
        const panel = $('#todayLogPanel');
        const list = $('#todayLogList');
        
        if (todayEntries.length === 0) {
            panel.style.display = 'none';
            return;
        }
        panel.style.display = 'block';
        panel.querySelector('h3').textContent = `Sets for ${date}`;
        
        list.innerHTML = todayEntries.map(e => `
            <div class="set-item" style="background:#1a1a1c;">
                <div class="set-info">
                    <strong>${e.reps}</strong> <span style="font-size:14px; color:var(--muted)">${e.type}</span>
                    ${e.note ? `<br><span style="font-size:12px;color:var(--muted)">${e.note}</span>` : ''}
                </div>
                <div class="set-actions">
                    <button class="ghost" onclick="openEditModal('${e.id}')">Edit</button>
                    <button class="ghost" style="color:var(--bad)" onclick="deleteEntry('${e.id}')">Del</button>
                </div>
            </div>
        `).join('');
    }

    function renderFullHistory(data) {
        const grouped = {};
        data.forEach(e => {
            const m = e.date.substring(0, 7);
            if(!grouped[m]) grouped[m] = {};
            if(!grouped[m][e.date]) grouped[m][e.date] = [];
            grouped[m][e.date].push(e);
        });
        
        const sortedMonths = Object.keys(grouped).sort().reverse();
        const html = sortedMonths.map(month => {
            const days = Object.keys(grouped[month]).sort().reverse();
            const monthTotal = days.reduce((sum, d) => sum + grouped[month][d].reduce((s,x)=>s+x.reps,0), 0);
            
            const daysHtml = days.map(day => {
                const dayTotal = grouped[month][day].reduce((s,x)=>s+x.reps,0);
                const daySets = grouped[month][day].map(e => `
                    <div class="set-item">
                        <div class="set-info"><strong>${e.reps}</strong> ${e.type}</div>
                        <div class="set-actions">
                             <button class="ghost" onclick="openEditModal('${e.id}')">Edit</button>
                             <button class="ghost" onclick="deleteEntry('${e.id}')">Del</button>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div class="day-group">
                        <div class="day-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
                            <span>${day}</span> <strong style="color:var(--accent)">${dayTotal}</strong>
                        </div>
                        <div class="day-sets" style="display:none">${daySets}</div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="month-group">
                    <div class="month-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
                        <span>${month}</span> <strong>${monthTotal} reps</strong>
                    </div>
                    <div class="month-content" style="display:none">${daysHtml}</div>
                </div>
            `;
        }).join('');
        $('#logContainer').innerHTML = html;
    }

    function renderChart(data) {
        const ctx = $('#chart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        const days = Number($('#chartDays').value);
        const labels = [], dataPoints = [];
        const today = new Date();
        
        for(let i=days-1; i>=0; i--) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const iso = d.toISOString().slice(0,10);
            labels.push(iso.slice(5));
            dataPoints.push(data.filter(e => e.date === iso).reduce((s,x)=>s+x.reps, 0));
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: currentExercise,
                    data: dataPoints,
                    borderColor: '#4f8cff',
                    backgroundColor: 'rgba(79, 140, 255, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { grid: { color: '#222' } }, y: { grid: { color: '#222' }, beginAtZero: true } },
                plugins: { legend: { display: true } }
            }
        });
    }

    function checkAchievements(oldS, newS, oldStr, newStr, reps, type) {
        if(newStr > oldStr && newStr % 5 === 0) showCelebration(`üî• ${newStr} Day Streak!`, "Consistency is key!");
        if(reps > oldS.pr_set.reps) showCelebration(`üí™ New PR: ${reps} Reps!`, "Strongest set ever!");
        if(newS.dailyTotals[$('#date').value] > oldS.pr_day.reps) showCelebration(`üöÄ New Daily Record!`, "Most reps in a single day!");
    }

    function showCelebration(title, msg) {
        const div = document.createElement('div');
        div.className = 'modal-overlay';
        div.innerHTML = `
            <div class="celebration">
                <div class="emoji">üéâ</div>
                <h2 style="color:var(--ok)">${title}</h2>
                <p style="color:var(--muted)">${msg}</p>
                <button class="primary" onclick="this.closest('.modal-overlay').remove()">Awesome!</button>
            </div>
        `;
        document.body.appendChild(div);
        setTimeout(()=>div.remove(), 4000);
    }

    // --- 6. HELPERS & INIT ---
    
    function setLoading(isLoading) {
        $('#loadingIndicator').style.display = isLoading ? 'block' : 'none';
        ['#addEntrySection', '#prSection', '#chartSection', '#summarySection'].forEach(s => {
            $(s).style.display = isLoading ? 'none' : (s.includes('pr')||s.includes('summary')?'flex':'block');
        });
    }

    function updateTypeDropdown() {
        const typeSelect = $('#type');
        typeSelect.innerHTML = ''; 
        const config = EXERCISE_CONFIG[currentExercise];
        
        config.types.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t; 
            opt.textContent = t; 
            typeSelect.appendChild(opt);
        });
        
        // Update Target default
        currentTarget = config.defaultTarget || 30;
        $('#dailyTarget').value = currentTarget;
    }

    function init() {
        flatpickr('#date', { defaultDate: 'today', dateFormat: 'Y-m-d', onChange: render });
        
        // Handle Exercise Selection Change
        $('#exerciseSelect').addEventListener('change', (e) => {
            currentExercise = e.target.value;
            updateTypeDropdown(); 
            render(); 
        });
        
        updateTypeDropdown();

        $('#addBtn').addEventListener('click', addEntry);
        $('#chartDays').addEventListener('change', () => {
             const filtered = allEntries.filter(e => e.exercise === currentExercise);
             renderChart(filtered);
        });
        $('#dailyTarget').addEventListener('input', (e) => { currentTarget = e.target.value; render(); });
        $('#expandAllBtn').addEventListener('click', () => document.querySelectorAll('.month-content, .day-sets').forEach(e=>e.style.display='block'));
        $('#collapseAllBtn').addEventListener('click', () => document.querySelectorAll('.month-content, .day-sets').forEach(e=>e.style.display='none'));

        window.deleteEntry = deleteEntry;
        
        // --- IMPROVED EDIT MODAL ---
        window.openEditModal = (id) => {
            const e = allEntries.find(x => x.id === id);
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // Generate options for Exercises
            const exOptions = Object.keys(EXERCISE_CONFIG).map(ex => 
                `<option value="${ex}" ${ex===e.exercise ? 'selected' : ''}>${ex}</option>`
            ).join('');

            // Generate options for Types (initially based on current exercise)
            const typeOptions = EXERCISE_CONFIG[e.exercise || 'Push-up'].types.map(t =>
                `<option ${t===e.type?'selected':''}>${t}</option>`
            ).join('');

            overlay.innerHTML = `
                <div class="modal">
                    <h3>Edit Set</h3>
                    <label>Exercise</label>
                    <select id="editExercise">${exOptions}</select>
                    
                    <label>Type</label>
                    <select id="editType">${typeOptions}</select>
                    
                    <label>Reps</label>
                    <input id="editReps" type="number" value="${e.reps}">
                    
                    <label>Note</label>
                    <input id="editNote" type="text" value="${e.note||''}">
                    
                    <div class="modal-buttons">
                        <button class="ghost" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="primary" id="saveEditBtn">Save</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            
            // Add listener to update Types when Exercise changes
            const exSelect = overlay.querySelector('#editExercise');
            const typeSelect = overlay.querySelector('#editType');
            
            exSelect.addEventListener('change', () => {
                const newEx = exSelect.value;
                const newTypes = EXERCISE_CONFIG[newEx].types;
                typeSelect.innerHTML = newTypes.map(t => `<option>${t}</option>`).join('');
            });

            overlay.querySelector('#saveEditBtn').onclick = () => {
                updateEntry(
                    id, 
                    Number($('#editReps').value), 
                    $('#editType').value, 
                    $('#editNote').value,
                    $('#editExercise').value
                );
                overlay.remove();
            };
        };

        fetchData();
    }

    init();
  </script>
</body>
</html>